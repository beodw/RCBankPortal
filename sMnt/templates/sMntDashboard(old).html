{% extends "sMntBase.html" %} 
{%load static%}
{%load get_usage%}
{%block AdditionalAssets%} 
<link rel="stylesheet" type="text/css" href="{% static 'aMgnt/assets/my_css/semantic-UI-hot-fix.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'aMgnt/assets/my_css/toastr-position-hot-fix.css' %}">
<style>
  .ui.blue.button {background-color: #024fcc; color: white;}
  .btn-height{height: 30px;}
  #toast-container > .toast-error {background-color: #f20000;}
  .perfect{width: 250px; height: 130px;}
  .table-header{background-color: rgba(255,255,255,1.);}
  body{overflow-y: scroll;}
</style>
{%endblock AdditionalAssets%}
{%block content%}
<div class='container-fluid'>
	<div class="ui segments container w-50" >
		<div class="ui circular segment">
		  <h2 class="ui header">
		    Current Serial No
		    <div class="sub header" id="current_serial_no">{{Init.initial_serial_number|add:"1"}}</div>
		  </h2>
		</div>
		<div class="ui circular segment">
		  <h2 class="ui header">
		    Quantity
		    <div class="sub header" id='Quantity'>{{Init.final_serial_number}}</div>
		  </h2>
		</div>
		<div class="ui circular segment">
		  <h2 class="ui header">
		    Total Usage
		    <div class="sub header" id="total_usage">{{Init.initial_serial_number}}</div>
		  </h2>
		</div>
		<div class="ui circular segment">
		  <h2 class="ui header">
		    Remaining Stock
		    <div class="sub header" id="remaining_stock">{{Init.final_serial_number|get_usage:Init.initial_serial_number}}</div>
		  </h2>
		</div>
	</div>
	<div class="ui segments container" style="width: 15%">
		<div class="ui raised segment">
			<form method="POST" id="setQuantForm" action="{% url 'sMntSetQuantity' %}">
				<label class="ui center aligned header" for="quant" >Set Quantity</label>
				<input type="number" min="0" name="quant" class="form-control" required />
				<button type="submit" class="ui tiny button mt-2" style="background-color: #c70000; color:white;">Submit</button>
				{%csrf_token%}
			</form>
		</div>
	</div>
	<h1>Printed Statements</h1>
	<hr>
	<div class="row w-100 d-flex flex-row-reverse mb-3"><!-- <a href="{% url 'sMntGenReport' %}"> --><button id="genReportButton" style="background-color: #964f03; color: white;" class="ui mini button"><i class="download icon"></i>Generate Report</button><!-- </a> --><button style="background-color: #00307d; color: white;" class="ui mini button" id="addStatementButton"><i class="plus icon"></i>Add Statement(s)</button></div>
	<table id="statmentsDashboard" class="table table-bordered table-sm table-condensed display">
		<thead style="background-color: rgba(50, 50, 90, 0.15);">
			<th>Date</th>
			<th>Branch</th>
			<th>Customer Name</th>
			<th>Account No</th>
			<th>Initial Serial Number</th>
			<th>Final Serial Number</th>
			<th>Usage</th>
		</thead>
		<tbody>
			<!-- tr generated by ajax -->
		</tbody>
	</table>
	<h1>Cancelled Statements</h1>
	<hr>
	<div class="row w-100 d-flex flex-row-reverse mb-3"><button class="ui mini button" id='cancelStatementButton' style="background-color: #00307d; color: white;"><i class="plus icon"></i>Add Statement(s)</button><button id="del_rec_button" style="background-color:#c70000; color:white;" class="ui tiny button"><i class="x icon"></i>Delete record</button></div>
	<table id="cancelledStatmentsDashboard" class="table table-bordered table-sm table-condensed">
		<thead class="thead-light">
			<th>Cancellation Date</th>
			<th>Initial Serial Number</th>
			<th>Final Serial Number</th>
			<th>Usage</th>
		</thead>
		<tbody>
			<!-- tr gen by ajax. -->
		</tbody>
	</table>
</div>
<!-- Modal to add statements -->
<div class="ui modal" id="addStatementModal" style="top: 9% !important; width: 400px;">
	<div class="header">Add Statement(s)<i class="close icon"></i></div>
	<div class="content">
		<form id="addStatementsRecordForm" method="POST" action='{%url "sMntAddRecord"%}' autocomplete="off">
			<div class="row"> 
				<label for="branch">Branch</label>
				<select class="form-control" name="branch" id="addStatementSelectBranch">
					<option selected value="">--Select a branch--</option>
					{%for branch in branches%}
						<option value="{{branch.username}}">{{branch.username}}</option>
					{%endfor%}
				</select>
		        <label for="customer_name">Customer Name</label>
		        <input type="text" name="customer_name" class="form-control" required />
		        <label for="account_no"> Account No</label>
		        <input type="text" name="account_no" class="form-control addStatementNumberInput" required />
		        <label for="initial_serial_number">Initial Serial Number</label>
		        <input type="number" min="{{Init.initial_serial_number|add:'1'}}" max='{{Init.final_serial_number}}' value="{{Init.initial_serial_number|add:'1'}}" name="initial_serial_number" class="form-control addStatementNumberInput" required />
		        <label for="final_serial_number">Final Serial Number</label>
		        <input type="number" name="final_serial_number" class="form-control addStatementNumberInput" max='{{Init.final_serial_number}}' required />
		    </div>
		</form>
	</div>
	<div class="actions"><button style='background-color: #00307d; color:white;' type="submit" id="addRecordSubmit" class="ui tiny button mt-2 ml-0">Submit</button></div>
</div>
<!-- Modal to cancel statements -->
<div class="ui mini modal" id="cancelStatementModal" style="top: 9% !important; width: 400px;">
	<div class="header">Cancel Statement(s)<i class="close icon"></i></div>
	<div class="content">
		<form id="cancelStatementsRecordForm" method="POST" action='{%url "sMntCancelStatments"%}' autocomplete="off">
			<div class="row"> 
		        <label for="Cinitial_serial_number">Initial Serial Number</label>
		        <input type="number" name="Cinitial_serial_number" class="form-control cNumInput" min='{{Init.initial_serial_number|add:"1"}}' value="{{Init.initial_serial_number|add:'1'}}" required />
		        <label for="Cfinal_serial_number" max='{{Init.final_serial_number}}'>Final Serial Number</label>
		        <input type="number" name="Cfinal_serial_number" max='{{Init.final_serial_number}}' class="form-control cNumInput" required />
		    </div>
		</form>	
	</div>
	<div class="actions"><button type="button" id="cancelStatementsubmit" style="background-color: #00307d; color: white;" class="ui tiny button mt-2 ml-0">Submit</button></div>
</div>
<!-- genReportModal -->
<div class="ui mini modal" id="genReportModal" style="top: 9% !important; width: 400px;">
	<div class="header">Generate Report<i class="close icon"></i></div>
	<div class="content">
		<form id="genReportForm" method="POST" action="{% url 'sMntGenReport' %}" autocomplete="off">
			{%csrf_token%}
			<div class="row">
				<label for="statement_type">For</label>
		        <select name="for" class="form-control" required>
		        	<option value="" selected>--Select a statement type--</option>
		        	<option value="customer_statements">Printed Statements</option>
		        	<option value="cancelled_statements">Cancelled Statements</option>
		        </select>
		        <div id="gen_report_select_branch_box" class="w-100">
					<label for="branch">Branch</label>
					<select name="branch" id="gen_report_branch" class="form-control" required>
						<option selected value="">--Select a branch--</option>
						<option value="all_branches">All Branches</option>
						{%for branch in branches%}
							<option value="{{branch.username}}">{{branch.username}}</option>
						{%endfor%}
					</select>
				</div>
		        <label for="intialDate">Date</label>
		        <input type="date" name="initialDate" class="form-control" required />
		    </div>
		</form>	
	</div>
	<div class="actions"><button type="button" id="genReportSubmit" style="width:85px;background-color: #964f03; color: white;" class="ui tiny icon button mt-2 ml-0"><i class="download icon"></i></button></div>
</div>

<!-- modal to delete a record --->
<div class="ui modal" id="delete_record_modal">
	<div class="ui header">Delete Record<i class="close icon"></i></div>
	<div class="content">
	<form method="POST" action="{% url 'sMntDelSmnt' %}">
		<p style="color:red; width: 85%; margin:auto;">Warning, submitting this form will delete the most recent record. Note, this action <strong><em>cannot</em></strong> be undone!</p>
	</div>
	
	{%csrf_token%}
		<div class="actions"><button type="submit" class="ui tiny button" style="color:white; background-color: #c70000;">Delete</button></div>
	</form>
</div>
{%csrf_token%}
{%endblock content%}
{%block scripts%}
<script type="text/javascript">
	var csrf_token = $('input[name="csrfmiddlewaretoken"]').val();
	toastr.options = {
	  "closeButton": false,
	  "debug": false,
	  "newestOnTop": false,
	  "progressBar": false,
	  "positionClass": "toast-top-center",
	  "preventDuplicates": true,
	  "onclick": null,
	  "showDuration": "700",
	  "hideDuration": "1000",
	  "timeOut": "2350",
	  "extendedTimeOut": "1000",
	  "showEasing": "swing",
	  "hideEasing": "linear",
	  "showMethod": "fadeIn",
	  "hideMethod": "fadeOut",
	};
	$('.close.icon').click(()=>{$('.ui.modal').modal('hide');});
	var statmentsDashboard = $('#statmentsDashboard').DataTable({
	  "fixedHeader": true,
      "responsive": true,
      "autoWidth": false,
      "aLengthMenu": [[10,20,30,50,70,100,200,500], [10,20,30,50,70,100,200,500]],
      "iDisplayLength": 200,
      "scrollY":true,
      "paging": true,
      "pageLength": 20,
      "lengthChange": true,
      "searching": true,
      "ordering": false,
      "info": true,
      'order':[[5,"desc"]],
      'processing':true,
      'serverSide':true,
      'ajax':{type:'POST',data:{'csrfmiddlewaretoken':csrf_token,'for':'customer_statements'},url:'{%url "sMntSearch" %}'},
    });
    var cancelledStatmentsDashboard = $('#cancelledStatmentsDashboard').DataTable({
	  "fixedHeader": true,
      "responsive": true,
      "autoWidth": false,
      "aLengthMenu":[[10,20,30,50,70,100,200,500], [10,20,30,50,70,100,200,500]],
      "iDisplayLength": 200,
      "paging": true,
      "pageLength": 20,
      "lengthChange": true,
      "processing":false,
      "serverSide":true,
      'ajax':{type:'POST', data:{'csrfmiddlewaretoken':csrf_token, 'for':'cancelled_statements'}, url:'{%url "sMntSearch" %}'},
      "searching": true,
      "ordering": false,
      "info": true,
      'order':[[2,"desc"]]
    });
    function addRow(tableObject,response,tableName){
		table_row = Array();
    	for (val in response){table_row.push(response[val])}
    	tableObject.row.add(table_row).draw(false);
    	if(tableName == 'cancelledStatmentsDashboard'){tableObject.order([2, 'desc']).draw();}
	    if(tableName == 'statmentsDashboard'){tableObject.order([5, 'desc']).draw();}
    }
    $('#addStatementModal').modal({'closable':false});
	$('#addRecordSubmit').click(()=>{
		if($('input[name="account_no"]').val().length != 13){toastr.error('Account number must be exactly 13 digits long.','Error');return}
		let flag = false;
		if($('#addStatementSelectBranch').val()==''){toastr.error('Select a branch.','Error');return}
		$('.addStatementNumberInput').each(function(){
			if (flag){return}
			if($(this).val() == ''){ toastr.error('All fields must be filled.','Error'); flag=true;}
			if(!/^[0-9]*$/.test( $(this).val() ) ){ let elem_name = $('label[for="'+ $(this).attr('name')+'"]').text(); toastr.error(elem_name + ' must be characters 0-9 only.','Error'); flag=true;}
			if(parseInt($('input[name="initial_serial_number"]').val()) > parseInt($('input[name="final_serial_number"]').val())){toastr.error('Final serial number must be larger than initial serial number.','Error');flag=true;} 
		});
		if (flag){return}
		$.ajax("{% url 'sMntAddRecord' %}",{method:"POST",success:(response)=>{if(response.error){toastr.error(response.message,'Error');return;};$('#current_serial_no').text(response.current_serial_number);$('#remaining_stock').text(response.remaining_stock);$('#total_usage').text(response.total_usage);delete response.remaining_stock;delete response.total_usage;addRow(statmentsDashboard,response,'statmentsDashboard');$('select[name="branch"]').prepend(`<option selected>--Select a branch--</option>`);$('#addStatementModal').modal('hide');$('#addStatementsRecordForm').trigger('reset');$('input[name="initial_serial_number"]').attr('min',response.final_serial_number);$('input[name="initial_serial_number"]').val(String(parseInt(response.final_serial_number)+1));$('input[name="Cinitial_serial_number"]').val(String(parseInt(response.final_serial_number)+1));$('#current_serial_no').text(String(parseInt(response.final_serial_number)+1));},error:()=>{toastr.error('Error','Unable to add record. Check internet connection or contact admin.')},data:{'statement':$('#addStatementsRecordForm').serialize(),"csrfmiddlewaretoken":csrf_token}});
	});
	$('#cancelStatementButton').click(()=>{$('#cancelStatementModal').modal('show')});
	$('#addStatementButton').click(()=>{$('#addStatementModal').modal('show');});
	$('#cancelStatementsubmit').click(()=>{
		let flag = false; 
		$('.cNumInput').each(function(){if(flag){return};if($(this).val()==''){toastr.error('All fields must be filled.','Error');flag=true;};if(!/^[0-9]*$/.test($(this).val())){toastr.error($('label[for="'+ $(this).attr('name')+'"]').text() + ' must be a number.','Error'); flag=true;};if(parseInt($('input[name="Cfinal_serial_number"]').val())<parseInt($('input[name="Cinitial_serial_number"]').val())){toastr.error('Final serial number must be higher than initial serial number','Error');flag=true;} });		
		if(!flag){$.ajax("{% url 'sMntCancelStatments' %}",{method:"POST",success:(response)=>{if(response.error){toastr.error(response.message,'Error');return;}$('#current_serial_no').text(response.current_serial_number);$('#remaining_stock').text(response.remaining_stock);$('#total_usage').text(response.total_usage);delete response.remaining_stock;delete response.total_usage;addRow(cancelledStatmentsDashboard,response,'cancelledStatmentsDashboard');$('.ui.modal').modal('hide');$('#cancelStatementsRecordForm').trigger('reset');$('input[name="initial_serial_number"]').val(String(parseInt(response.final_serial_number)+1));$('input[name="Cinitial_serial_number"]').val(String(parseInt(response.final_serial_number)+1));},error:()=>{toastr.error('Error','Unable to add record. Check internet connection or contact admin.')},data:{'statement':$('#cancelStatementsRecordForm').serialize(),"csrfmiddlewaretoken":csrf_token}}); }
	});
	// $('#genReportModal').modal({onHidden: ()=>{$('input[name="initialDate"]').val('');if(!$('select[name="branch"]').children('option:contains(--Select a branch--):last') ){$('select[name="branch"]:last').prepend(`<option selected value="">--Select a branch--</option>`)}$('select[name="statement_type"]').val('');}});
	$('#genReportButton').click(()=>{$('#genReportModal').modal('show')});
	$('#genReportSubmit').click(()=>{if($('input[name="initialDate"]').val() != '' && $('select[name="statement_type"]').val() != '' && $('#gen_report_branch').val() != ''){$('#genReportForm').submit();$('.ui.modal').modal('hide');$('input[name="initialDate"]').val('');$('#gen_report_branch').prepend(`<option selected value="">--Select a branch--</option>`);$('select[name="statement_type"]').val('');}else{toastr.error('Please fill out all fields.','Error');}});
	if({{error}}){toastr.error('{{message}}','Error');}
	if({{success}}){toastr.success('{{message}}','Success');}
	$('select[name="branch"]').change(function(){$(this).children(':contains(--Select a branch--)').remove()});
	$('select[name="statement_type"]').change(function(){$(this).children(':contains(--Select a statement type--)').remove();});
	$('select[name="for"]').change(function(){$(this).children(':contains(--Select a statement type--)').remove(); if($(this).val() == 'cancelled_statements'){$('#gen_report_select_branch_box').children().each(function(){$(this).remove();});}else{$('#gen_report_select_branch_box').html(`<label for="branch">Branch</label>
					<select name="branch" id="gen_report_branch" class="form-control" required>
						<option selected value="">--Select a branch--</option>
						<option value="all_branches">All Branches</option>
						{%for branch in branches%}
							<option value="{{branch.username}}">{{branch.username}}</option>
						{%endfor%}
					</select>`);} });

	$('#del_rec_button').click(()=>{$('#delete_record_modal').modal('show')});
</script>
{%endblock scripts%}