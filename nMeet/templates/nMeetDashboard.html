{% extends "nMeetBase.html" %} 
{%load static%}
{%block AdditionalAssets%} 
<link rel="stylesheet" type="text/css" href="{% static 'aMgnt/assets/my_css/semantic-UI-hot-fix.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'aMgnt/assets/my_css/toastr-position-hot-fix.css' %}">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp"
      rel="stylesheet">
<style>
  .deleteModalMessage{width:auto;}
	@media only screen and (max-width: 850px){
		.deleteModalMessage{
			width: 100%;
		}
	}
		@media only screen and (max-width: 600px){
		.deleteModalMessage{
			width: 54.67%;
		}
	}
  .ui.blue.button {background-color: #024fcc; color: white;}
  .message { margin-right: 10px; }
  .updated { background-color:rgba(3, 3, 158,0.3); color:black; }
  td[colspan="5"] {text-align: center;}
  .hover{ animation-name: floating;
    animation-duration: 1s;
    animation-iteration-count: 1;
    animation-timing-function: ease-in-out;
    }
  @keyframes floating {
    0% { transform: translate(0,  0px); }
    25% { transform: translate(0,  -6px);  }
    50%  { transform: translate(0, -12px);  }
    75%  { transform: translate(0, -6px); }
    100%   { transform: translate(0, 0px); }    
}
.ui.compact.floating.message{background-color: white;}
  
</style>
{%endblock AdditionalAssets%}
{%block content%}
<div class='container-fluid'>
	<div class="row mb-0">
		<div class="col-6"><h1>Dashboard</h1></div>
		{%if request.user.username == 'Admin'%}
			<div class="col-6 d-flex flex-row-reverse">
				<form action="{% url 'nMeetSaveDashboard' %}" method="POST">
					{%csrf_token%}
					<button type="button" style="background-color: #9e0303;" id="clear_dashboard_button" class="mdc-fab inline-demo-fab mdc-ripple-upgraded mr-2">
				      <div class="mdc-fab__ripple"></div>
				    <img src="{% static 'aMgnt/assets/google icons/delete_forever_white_24dp.svg' %}">
				    </button>
				<!-- 	<button type="submit" style="background-color: #00307d; color: white;" class="ui mini icon button" id="save-dashboard-button"><i class="download icon"></i>Save dashboard</button> -->
					<button type="submit" style="background-color: #0040a6;" id="save-dashboard-button" class="mdc-fab inline-demo-fab mdc-ripple-upgraded mr-2">
				      <div class="mdc-fab__ripple"></div>
				    <img src="{% static 'aMgnt/assets/google icons/file_download_white_24dp.svg' %}">
				    </button>
				</form>
			</div>
		{%else%}
			<div class="col-6 d-flex flex-row-reverse">
				<form action="{% url 'nMeetSaveDashboard' %}" method="POST">
					{%csrf_token%}
						<button type="submit" style="background-color: #0040a6;" id="save-dashboard-button" class="mdc-fab inline-demo-fab mdc-ripple-upgraded mr-2">
						      <div class="mdc-fab__ripple"></div>
						    <img src="{% static 'aMgnt/assets/google icons/file_download_white_24dp.svg' %}">
					    </button>
				</form>
			</div>
		{%endif%}
	</div>
	<hr class="mt-2">
	<div id="dashboard-container">
		<table style="zoom:110%;" id="dashboard"  class="table table-bordered table-sm table-hover table-condensed">
		<thead style="background-color: rgba(50, 50, 90, 0.15);">
		  <tr>
		    <th>Branch</th>
		    <th>Teller or operator</th>
		    <th>Debit</th>
		    <th>Credit</th> 
		    <th>Time Sent</th> 
		  </tr>
		</thead>
		<tbody id="dashboard_table_body">
		  {%if dashboard%}
		  {%else%}
		      <tr>
		          <td colspan="9" class="dataTables_empty">No Figures Have Been Sent</td>
		          <!-- Hide td so dataTables does not throw any errors -->
		          <td hidden></td>
		          <td hidden></td>
		          <td hidden></td>
		          <td hidden></td>
		      </tr>
		  {%endif%}
		</tbody>
		</table>
	<div>
	<div id="chat-container" class="mt-2 ui segment">
		<div class="row w-100 mb-5" style="margin-left: 0px; margin-bottom: 0px;">
			{% if user.username == 'Admin' %}
			<div class="col-4"><h1 class="header">Chat</h1></div>
			<span class="col-4 mb-0 d-flex justify-content-center pt-3" style="color: red; font-weight: bold; margin-bottom:0px;"><h4 id="chat-error" hidden></h4></span>
			<div class="col-4 d-flex flex-row-reverse"><button id="clear-chat-button" style="border-radius:30px;" class="ui bg-warning tiny button">Clear Chat</button></div>{%elif user.username == 'IT SUPPORT'%}<div class="col-4"><h1 class="header">Chat</h1></div><span class="col-4 mb-0 d-flex justify-content-center pt-3" style="color: red; font-weight: bold; margin-bottom:0px;"><h4 id="chat-error" hidden></h4></span>	<div class="col-4 d-flex flex-row-reverse">
<div id="freeze-chat-button" style="background-color: #0040a6; color: whitesmoke; border-radius:35px; height: 35px; width:50px; display: flex; align-items:center; justify-content: center;" class="ui mini icon button freeze-chat-button" tabindex="0">
    <i class="lock open icon"></i>
    <i class="lock icon" id="lock-icon" style="display: none;"></i>
</div>
<!--<button id="freeze-chat-button" style="width:50px;height:40px;border-radius:10px;background-color: #0040a6; color: white;" class="ui tiny icon button"><i class="large open lock icon"></i></button>--></div>{%else%}<div class="col-4"><h1 class="header"></h1></div><span class="col-4 d-flex justify-content-center mb-0 pt-3" style="color: black; font-weight: bold; margin-bottom:0px;"><h1 class="ui dividing header">Chat</h1></span><div class="col-4"></div>{%endif%}
		</div>
		<!-- <hr> -->
		<div  id="chat-text-area" class="w-100" style="overflow-y:auto;overflow-x:auto;height: 300px;"></div>
		<h3 class="header col-6">Send Message</h3>
		<textarea id="input-text" required class="form-control" placeholder="Type message in here..."></textarea>
		<button id="send-message-button" style="background-color: #00307d; color: white;"  class="ui tiny button mt-2 mb-2">Send</button>
	</div>
</div>
{%csrf_token%}
<!-- Modal to clear dashboard -->
<div class="ui modal" id="clear-dashboard-modal" >
	<div class="row d-flex flex-row-reverse mt-3">
				<button tabindex="-1" class="ui icon button modalCloser" style="background-color: rgba(127.5,127.5,127.5,0.1);border-radius: 50%;margin-right:30px; ">
				 <i class="x icon modalCloser"></i>
				</button>
	</div>
  <div class="image content">
    <div class="description">
    	<div style="margin: auto; width:80%;">
    		<input hidden type="number" name="message_id">
    		<div style="margin:auto; width:50%;" class="d-flex justify-content-center">
    			<h1 style="font-family: serif;font-weight: bold;">Clear Dashboard</h1>
    		</div>
    		<hr>
    		<div class="deleteModalMessage d-flex justify-content-center" style="margin:auto;">
				  <h3 style="color:red; font-weight: bold;">
	    				Warning: The dashboard holds all the figures for every branch.Once it is cleared this action <em>cannot</em> be undone!
	    		</h3>
				</div>
    	</div>
    </div>
  </div>	    	
  <form method="post" id="clear-dashboard-form" action="{% url 'nMeetClearDashboard' %}">
	  <div class="d-flex justify-content-center mb-5" style="padding: 0px 0px 15px 0px; ">
	    <!-- <div id="clear-dashboard-options"><div class="ui red button cancelModalButton" style='padding: 14px 25px; width:120px;'>Abort</div> -->
	    <!-- <div class="ui blue button" onClick="toggleEnterAdminPassword()" style=' padding: 15px 30px;  width:120px;'>Yes</div></div> -->
	    <div hidden="hidden" id="clear-dashboard-enter-password" class="d-flex justify-content-center p-1" style="width:50%; background-color:white; border-style:solid; border-width:2px; border-color: rgba(0,0,255,0.55);" >

		    	{%csrf_token%} 
		    	<input autofocus id="admin-password-input" placeholder="Enter Admin password" class="h-100" style="padding-left:5px;border-radius: 30px; width: 70%;display: inline-block;border:none; outline-width: 0;" type="password" name='admin_password' required minlength="8" />
		    				
				  <button type="submit" class="btn" style="height: 42.5px;background: linear-gradient(0.35turn, #369dc9, #e8a864); border-color: white; margin: 0px 0px 0px 10px; width: 30%;display: inline-block; color:white; ">
				  	<span>Submit</span>
				  </button>
				
	    </div>
	  </div>
</form>
</div>

<div class="ui modal" id="delete_message_modal">
<!-- <div class="mt-1 mb-5"> -->
	<div class="row d-flex flex-row-reverse mt-3">
				<button class="ui icon button modalCloser" style="background-color: rgba(127.5,127.5,127.5,0.1);border-radius: 50%;margin-right:30px; ">
				 <i class="x icon modalCloser"></i>
				</button>
	</div>
  <div class="image content">
    <div class="description">
    	<div style="margin: auto; width:80%;">
    		<input hidden type="number" name="message_id">
    		<div style="margin:auto; width:50%;" class="d-flex justify-content-center">
    			<h1 style="font-weight: bold;"><span style="font-family:, serif;">Are You Sure</span>?</h1>
    		</div>
    		<hr>
    		<div class="deleteModalMessage d-flex justify-content-center" style="margin:auto;">
				  <h3 style="color:red; font-weight: bold;">
	    				Warning, you are about to delete this message and this action <em>cannot</em> be undone!
	    		</h3>
				</div>
				  <div class="deleteModalMessage d-flex justify-content-center" style="margin:auto; ">
				  	<h3 style="color:red; font-weight: bold;">Would you like to proceed?</h3>
				  </div>
    	</div>
    </div>
  </div>
  <div class="d-flex justify-content-center mb-5" style="padding: 0px 0px 15px 0px;">
    <div class="ui red button cancelModalButton" style='padding: 14px 25px; width:120px;'>Abort</div>
    <div class="ui blue button" onClick="deleteMessage()" style='background: linear-gradient(0.35turn, #369dc9, #e8a864); padding: 15px 30px;  width:120px;'>Yes</div>
  </div>
<!-- </div> -->
</div>
<div class="ui modal" id="connection-error-modal">
		<div class="row d-flex flex-row-reverse mt-3">
				<button class="ui icon button modalCloser" style="background-color: rgba(127.5,127.5,127.5,0.1);border-radius: 50%;margin-right:30px; ">
				 <i class="x icon modalCloser"></i>
				</button>
		</div>

		<div class="image content">
	    <div class="description">
	    	<div style="margin: auto; width:80%;">
	    		
	    		
	    		<div class="deleteModalMessage d-flex justify-content-center" style="colro: rgba(0, 0, 0, 0.55);font-size: 24px;margin:auto;">
						<div class="row">
						  <div class="ui center aligned icon header">
								  <i class="red circular wifi icon"></i>
							</div>
						</div><br>
						<div class="row"><h2>Could not contact server.</h2></div><br>
						<div class="row"><h4>Check your internet or contact IT SUPPORT if problem persists.</h4></div> 
					</div>
	    	</div>
	    </div>
	  </div>


</div>
{%endblock content%}
{%block scripts%}
<script src="{% static '/nMeet/assets/plugins/tinymce_5.7.0/tinymce/js/tinymce/tinymce.min.js'%}" type="text/javascript"></script>
<script src="{% static '/nMeet/assets/plugins/tinymce_5.7.0/tinymce/js/tinymce/jquery.tinymce.min.js'%}" type="text/javascript"></script>
<script>
      $('textarea#input-text').tinymce({
        height: 170,
        menubar: false,
        plugins: [
          // 'advlist autolink lists link image charmap print preview anchor',
          // 'searchreplace visualblocks code fullscreen',
          // 'insertdatetime media table paste'
          'paste '
        ],
        toolbar: 'bold {%if user.username == "IT SUPPORT" or user.username == "Admin"%}italic backcolor forecolor{%endif%}'
      });
    </script>
<script type="text/javascript">
	toastr.options = {
		  "closeButton": false,
		  "debug": false,
		  "newestOnTop": false,
		  "progressBar": false,
		  "positionClass": "toast-top-center",
		  "preventDuplicates": true,
		  "onclick": null,
		  "showDuration": "300",
		  "hideDuration": "1000",
		  "timeOut": "2050",
		  "extendedTimeOut": "1000",
		  "showEasing": "swing",
		  "hideEasing": "linear",
		  "showMethod": "fadeIn",
		  "hideMethod": "fadeOut",
	}
{%if success%}
	toastr.success('{{message}}','Success')
{%elif error%}
	toastr.error('{{message}}','Error')
{%endif%}
</script>
<script type="text/javascript">
	//csrf token
	var csrf_token = $('input[name="csrfmiddlewaretoken"]').val();
	var error_message_shown = false;
	var dashboard_connected = false;
	var init_connect_shown = false;
	var user = '{{user.username}}'
	var dashboard_buffer = [];
	var dashboard_buffer_size = "200";
	var response_cache = [];
	var dashboard_init = true;
	var clearing = false;
	var chatIsFrozen = false;
  var toggleEnterAdminPassword = ()=>{
			$('#clear-dashboard-options').transition({animation:'fade',onComplete:()=>{},});
	}
	// $('#clear-dashboard-enter-password').on('input',(event)=>{$('#admin-password-input').css('border-color','blue');});
	$('#admin-password-input').on('focusout focusin input', (focusEvent)=>{
						var borderColor = ''
						if(focusEvent.type=='input'){
							borderColor = 'rgba(0,0,255,0.55)';
						}
						else if(focusEvent.type=='focusin'){
							borderColor = 'rgba(0,0,255,0.55)';
						}
						else{
							borderColor = 'rgba(0,0,255,0.15)';
						}
						$('#clear-dashboard-enter-password').css('border-color',borderColor);
	});
	$('.modalCloser').click(()=>{$('.ui.modal').modal('hide');});
	$(document).ready(()=>{
		//Initialize dataTable that refreshes intermittently using ajax.
		var dashboard = $("#dashboard").DataTable({
		  "fixedHeader": true,
	      "responsive": true,
	      "autoWidth": false,
	      "aLengthMenu": [[-1], ["All"]],
	      "iDisplayLength": -1,
	      "paging": false,
	      "lengthChange": true,
	      "searching": false,
	      "ordering": true,
	      "info": false,
	      "order":[[0,"asc"],[1,"asc"]],
	      "processing":false,
		  "serverSide":false,
	    });
	    //Initialize and refresh dashboard.
	    function refreshDashboard(dashboard_buffer_size){
	    	// length is the number of entries to be returned by backend ordered by most recent.
	    	if(dashboard_buffer.length==0 && dashboard_init){
	    		$.ajax("{%url 'nMeetDashboard' %}",{method:"POST",data:{"csrfmiddlewaretoken":csrf_token, "length":dashboard_buffer_size},error:()=>{dashboard_connected = false;dashboard.row(0).remove().draw();$('#connection-error-modal').modal('setting','transition','fade right').modal('show');/*toastr.error('Unable to reach server. Please contact IT SUPPORT if this error persists.');*/},success:(response)=>{if(!init_connect_shown){toastr.success('Dashboard Connected');init_connect_shown = true;dashboard_connected = true}else{if(!dashboard_connected){toastr.success('Dashboard Reconnected');dashboard_connected = true}};dashboard_buffer = response['dashboard'];response_cache=response['dashboard'];dashboard.row(0).remove().draw();addRow(response['cancelled'],dashboard,response['dashboard']);}});
	    	}
	    	else{
		    	$.ajax("{%url 'nMeetDashboard' %}",{method:"POST",data:{"csrfmiddlewaretoken":csrf_token, "length":dashboard_buffer_size},error:()=>{dashboard_connected = false;toastr.error('Unable to reach server. Please contact IT SUPPORT if this error persists.');},success:(response)=>{if(!init_connect_shown){toastr.success('Dashboard Connected');init_connect_shown = true;dashboard_connected = true}else{if(!dashboard_connected){toastr.success('Dashboard Reconnected');dashboard_connected = true}};addRow(response['cancelled'],dashboard,response['dashboard']);}});
		    }
	    }
	    // Check if dashboard_buffer contains any new record and adds those records.
	    function addRow(cancelled_figs,tableObject,response,init){
	    	if(response.length == 0){dashboard_buffer=[];dashboard.clear().draw();}
	    	else if (!dashboard_init){
	    		if(!(JSON.stringify(response) === JSON.stringify(response_cache))){
	    			for (id of cancelled_figs){
	    				let result = binarySearch(dashboard_buffer,id);
	    				if (result.found){dashboard_buffer.splice(result.index,1);tableObject.row(result.index).remove().draw();}
	    			}
			    	for(row of response){
			    		let result = binarySearch(dashboard_buffer,row[0]);
			    		if (!result.found){dashboard_buffer.push(row);tableObject.row.add(row.slice(1,6)).draw();}
			    		else if(row[6]=='updated'){
				    			dashboard_buffer[result.index]=row;
				    			$(tableObject.row(result.index).data(row.slice(1,6)).draw().node()).addClass('updated');
				    	}
				    	 
			    	}
			    	response_cache = response;
		    	}
		    }
		    else{
		    	for(row of dashboard_buffer){
		    		if(row[6]=='not_updated'){tableObject.row.add(row.slice(1,6)).draw();}
		    		else{$(tableObject.row.add(row.slice(1,6)).draw().node()).addClass('updated');}
		    	}
		    	dashboard_init=false;	
		    }
   		}
   		function binarySearch(sortedArray, key){
		    let start = 0;
		    let end = sortedArray.length - 1;
		    while (start <= end) {
		        let middle = Math.floor((start + end) / 2);
		        if (sortedArray[middle][0] === key){return {'found':true,'index':middle};} 
		        else if (sortedArray[middle][0] < key){start = middle + 1;} 
		        else {end = middle - 1;}
		    }
		    return {'found':false};/*row id not found.*/
		}

		//Intialize chat with all previously sent messages if any.
		//TO DO:
		//Add array for deleted messages
		//Upon updating chat check if any deleted mesage id is currently in chat.
		//If so remove from messages array and use jquery to remove from chat section and notify user of deletion.
		
		var chat = Array(); // [ [...,message_id] , [...,message_id], [...,message_id], ... ]
		$.ajax("{% url 'nMeetChat' %}",{method:"GET",success:(response)=>{chat = response.chat; for(row of response.chat){$('#chat-text-area').append(`<div padding-left:0px; padding-right:20px;" class="mt-0 ui compact floating message"><button onClick="showDeleteMessageWarning(${row[3]})" style="background-color: rgba(127.5,127.5,127.5,0.1);border-radius:50%;justify-content:center; padding: 10px 10px 10px 10px; width:30px;" class="ui button deleteMessage"> <i class="x icon"></i></button><span class="message">( ${row[0]} ) ${row[1]} : </span><p style="position:absolute; left:200px; margin: 0px 0px 0px 40px;"> ${row[2]}</p></div><br/>`);scrollToLastMessage(30);} },error:()=>{toastr.error('The chat serivce is currently unavailable.', 'Error')}});
		//Handling deleted messages.
		var deleted_messages = Array();
		$.ajax("{% url 'nMeetDeletedMessages' %}",{
				method:"GET", 
				success:(response)=>{
					deleted_messages = response.deleted_messages;
					console.log(deleted_messages);
				} 
		});

		showDeleteMessageWarning = (message_id) => {
			$('input[name="message_id"]').val(message_id);
			$('#delete_message_modal').modal('setting','transition','fade right').modal('show');
		}

		deleteMessage = () => {

					$.ajax(" {% url 'nMeetDeleteMessage' %} ",
						{
							method: 'POST',
							data: { 
									message_id : $('input[name="message_id"]').val(),
									csrfmiddlewaretoken:csrf_token
								},
							success: (response)=>{
								if(response.success == 1){}
								else{ toasr.error('Could not delete message. Please contact Admin.','Error');}
								$('.ui.modal').modal('hide');
							},
							error:()=>{
								toastr.error('Could not delete message. Check your internet connection.', 'Error');
							},
						});

		}

		$('.cancelModalButton').click( () => {$('.ui.modal').modal('hide');});
		
		//Set jquery ajax to update chat intermittently and implement logic to send messages when send button clicked.
		function refreshChat(){if(!clearing){
			$.ajax("{% url 'nMeetRefreshChat' %}",{method:"GET",success:(response)=>{
				$('#chat-error').attr('hidden','');
				if(error_message_shown){ toastr.success('Chat Reconnected',''); error_message_shown = false;}
				if(response.chat_buffer.length == 0){ chat = []; $('#chat-text-area').text('');}
				else{
					for (var i = 0; i < response.chat_buffer.length; i++) {
						if(i > chat.length - 1){
							chat.push(response.chat_buffer[i]); 
							$('#chat-text-area').append(`<div style=" padding-left:20px; padding-right:20px;" class="mt-0 ui floating compact message hover"><button onClick="showDeleteMessageWarning(${response.chat_buffer[i][3]})" style="justify-content:center;background-color: rgba(127.5,127.5,127.5,0.1);border-radius:50%; padding: 10px 10px 10px 10px; width:30px;" class="ui button deleteMessage"> <i class="x icon"></i></button><span class="message">( ${response.chat_buffer[i][0]} ) ${response.chat_buffer[i][1]} : </span>${response.chat_buffer[i][2]}</div><br/>`);
							if(!chatIsFrozen){scrollToLastMessage();}
							if(response.chat_buffer[i][1] != user){toastr.info('A new message has arrived from '+response.chat_buffer[i][1]+'.','Message');}
						}
						else{
							if (response.chat_buffer[i][3] != chat[i][3]){chat.push(response.chat_buffer[i]); $('#chat-text-area').append(`<div  style=" padding-left:20px; padding-right:20px;" class="mt-0 ui floating compact message hover"><button onClick="showDeleteMessageWarning(${response.chat_buffer[i][3]})" style="background-color: rgba(127.5,127.5,127.5,0.1);border-radius:50%;justify-content:center; padding: 10px 10px 10px 10px; width:30px;" class="ui button deleteMessage"> <i class="x icon"></i></button><span class="message">( ${response.chat_buffer[i][0]} ) ${response.chat_buffer[i][1]} : </span>${response.chat_buffer[i][2]}</div><br/>`);if(!chatIsFrozen){scrollToLastMessage();}if(response.chat_buffer[i][1]!= user){toastr.info('A new message has arrived from '+response.chat_buffer[i][1]+'.','Message');}}
						}
					}
				}
			},
			error:()=>{ $('#chat-error').removeAttr('hidden'); error_message_shown = true; }});
		}}
		function sendMessage(text){
			$.ajax("{% url 'nMeetChat' %}",{method:"POST",success:(response)=>{$('#input-text').val(''); $('#input-text').removeAttr('disabled');$('#send-message-button').removeAttr('disabled'); $('#send-message-button').text('Send'); $('#send-message-button').addClass('blue');},error:()=>{toastr.error('Error','Unable to send to chat.')},data:{'text':text,"csrfmiddlewaretoken":csrf_token}});
		}
		$('#input-text').on('input', function(){$(this).removeAttr('style')});
		$('#send-message-button').click(()=>{if ($('#input-text').val() != '') {$('#input-text').attr('disabled',''); $('#send-message-button').attr('class','ui tiny button mt-2 mb-2');$('#send-message-button').attr('disabled',''); $('#send-message-button').text('Sending...');sendMessage($('#input-text').val());} }); 
		setInterval(function(){refreshChat();}, 1000);
		{%if user.username == 'Admin'%}
		//Handle showing and submitting clear dashboard modal form.
		$('.close.icon').click(()=>{$('.ui.modal').modal('hide');});
		$('#clear_dashboard_button').click(()=>{ $('#clear-dashboard-modal').modal({transition:'fade right',onVisible:()=>{$('#admin-password-input').focus();}}).modal('show');});
		$('#clear-dashboard-form').submit((e)=>{e.preventDefault(); $('#clear-button').removeClass('red');$('#clear-button').text('Clearing...'); $.ajax("{% url 'nMeetClearDashboard' %}",{method:'POST',data:{'csrfmiddlewaretoken':csrf_token, 'admin_password':$('input[name="admin_password"]').val()},success:(response)=>{$('#clear-button').addClass('red'); $('#clear-button').text('Clear'); if(response.success){ toastr.success('Dashboard has been cleared successfully','Success'); $('.ui.modal').modal('hide');}else{$('#clear-dashboard-enter-password').css('border-color','red');$('#clear-dashboard-enter-password').transition('jiggle');} $('input[name="admin_password"]').val(''); },error:()=>{toastr.error('Could not connect to dashboard.'); }});});
		//Clear chat when clear button clicked.
		$('#clear-chat-button').click(()=>{clearing=true;$('#clear-chat-button').removeClass('bg-warning'); $('#clear-chat-button').text('Clearing...'); $.ajax("{% url 'nMeetClearChat' %}",{method:'POST',data:{'csrfmiddlewaretoken':csrf_token},success:()=>{clearing=false;toastr.success('Chat has been cleared successfully.','Success'); $('#clear-chat-button').addClass('bg-warning'); $('#clear-chat-button').text('Clear Chat');  },error:()=>{clearing=false;toastr.error('Error','An error occured while contacting the chat application.')}}); });
		{%endif%}
		//Show loader and get dashboard after everything in page has been loaded.
		var loading_row = $(dashboard.row.add(['','','','','']).draw().node());
		loading_row.html(`<td colspan="5"><div class="ui active inline small text loader">Loading dashboard...</div></td>`)
		refreshDashboard("-1");
		setInterval(function(){refreshDashboard(dashboard_buffer_size);}, 3000);
		 function scrollToLastMessage(speed){if(speed == undefined){speed=1500;} $('#chat-text-area').animate({
         scrollTop: $('#chat-text-area').prop("scrollHeight")
     }, speed);}
	});
	//To remove tinyMCE branding.
	window.onload = function(){$('.tox-statusbar__branding').remove();}
</script>
<script type="text/javascript">
	function freezeChatTransition(){
		if(chatIsFrozen){
			chatIsFrozen=false;
			$('.lock.open.icon').transition({
				animation:'fade left',
				duration:200,
			});
			$('#lock-icon').transition({animation:'fade right',duration:100,});
			$('.freeze-chat-button').css('background-color','#0040a6');
		
		}else{ 
			chatIsFrozen=true;
			$('#lock-icon').transition({
				animation:'fade right',
				duration:200,
			});
			$('.lock.open.icon').transition({animation:'fade left',duration:100,});
			$('.freeze-chat-button').css('background-color','#e63402');
		}
	}
	$('.freeze-chat-button').click(freezeChatTransition);
</script>
{%endblock scripts%}